<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MITA 2014 JSON Viewer - Validation Mode</title>
    <style>
        /* Minimal styling - readable but simple */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            line-height: 1.5;
            background: #fafafa;
            color: #222;
        }
        
        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #333;
            color: #fff;
            border-bottom: 2px solid #000;
            padding: 10px;
            z-index: 100;
        }
        nav select, nav button {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            margin-right: 10px;
            padding: 4px 8px;
        }
        nav label {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            margin-right: 15px;
            color: #fff;
        }
        
        /* Main content - side by side */
        .container {
            display: flex;
            margin-top: 55px;
        }
        .panel {
            flex: 1;
            padding: 15px;
            border-right: 2px solid #333;
            overflow-y: auto;
            height: calc(100vh - 55px);
            background: #fff;
        }
        .panel:last-child {
            border-right: none;
        }
        .panel-header {
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: #000;
        }
        
        /* Field display */
        .field {
            margin-bottom: 12px;
            border: 1px solid #999;
            background: #fff;
        }
        .field-name {
            font-weight: bold;
            color: #000;
            background: #ddd;
            padding: 4px 8px;
            border-bottom: 1px solid #999;
        }
        .field-value {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 8px;
            color: #222;
        }
        .field-value.empty {
            color: #888;
            font-style: italic;
        }
        
        /* Arrays */
        .array-item {
            border-left: 3px solid #666;
            padding-left: 12px;
            margin: 8px 0;
        }
        .array-index {
            color: #555;
            font-size: 11px;
            font-weight: bold;
        }
        
        /* Nested objects */
        .nested {
            margin-left: 15px;
            border-left: 2px dashed #999;
            padding-left: 12px;
        }
        
        /* Raw JSON toggle */
        .raw-json {
            background: #f5f5f5;
            border: 2px solid #333;
            padding: 12px;
            white-space: pre-wrap;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        /* Metadata highlight */
        .metadata {
            background: #fffde0;
            border-color: #cc0;
        }
        
        /* BCM table for levels */
        .question-block {
            border: 2px solid #333;
            margin-bottom: 20px;
            background: #fff;
        }
        .question-header {
            background: #ddd;
            padding: 8px;
            border-bottom: 1px solid #333;
            font-weight: bold;
            color: #000;
        }
        .question-text {
            font-weight: bold;
            padding: 8px;
            color: #000;
            background: #f0f0f0;
            border-bottom: 1px solid #999;
        }
        .question-note {
            background: #fffde0;
            padding: 8px;
            border-bottom: 1px solid #cc0;
            color: #333;
        }
        .levels-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .levels-table th, .levels-table td {
            border: 1px solid #666;
            padding: 8px;
            vertical-align: top;
            width: 20%;
        }
        .levels-table th {
            background: #333;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }
        .levels-table td {
            white-space: pre-wrap;
            color: #222;
            background: #fff;
        }
        .levels-table td.empty {
            color: #888;
            font-style: italic;
            background: #f5f5f5;
        }
        
        /* Loading/error states */
        .loading { color: #666; }
        .error { color: #c00; font-weight: bold; }
    </style>
</head>
<body>
    <nav>
        <label>Business Area:
            <select id="areaSelect"></select>
        </label>
        <label>Process:
            <select id="processSelect"></select>
        </label>
        <button onclick="loadProcess()">Load</button>
        <label>
            <input type="checkbox" id="showRawJson" onchange="toggleRawJson()">
            Show Raw JSON
        </label>
        <label>
            <input type="checkbox" id="showMetadata" checked onchange="rerender()">
            Show Metadata
        </label>
    </nav>
    
    <div class="container">
        <div class="panel" id="bptPanel">
            <div class="panel-header">BPT (Business Process Table)</div>
            <div id="bptContent" class="loading">Select a process...</div>
        </div>
        <div class="panel" id="bcmPanel">
            <div class="panel-header">BCM (Business Capability Matrix)</div>
            <div id="bcmContent" class="loading">Select a process...</div>
        </div>
    </div>

    <script>
        // Business areas and their folder names
        const AREAS = {
            'Business Relationship Management': 'business_relationship_management',
            'Care Management': 'care_management',
            'Contractor Management': 'contractor_management',
            'Eligibility and Enrollment Management': 'eligibility_and_enrollment_management',
            'Financial Management': 'financial_management',
            'Operations Management': 'operations_management',
            'Performance Management': 'performance_management',
            'Plan Management': 'plan_management',
            'Provider Management': 'provider_management'
        };

        // Process lists per area (will be populated)
        let processLists = {};
        let currentBPT = null;
        let currentBCM = null;

        // Initialize
        async function init() {
            const areaSelect = document.getElementById('areaSelect');
            
            // Populate area dropdown
            for (const [name, folder] of Object.entries(AREAS)) {
                const opt = document.createElement('option');
                opt.value = folder;
                opt.textContent = name;
                areaSelect.appendChild(opt);
            }
            
            areaSelect.addEventListener('change', loadProcessList);
            await loadProcessList();
        }

        // Load process list for selected area
        async function loadProcessList() {
            const areaFolder = document.getElementById('areaSelect').value;
            const processSelect = document.getElementById('processSelect');
            processSelect.innerHTML = '';
            
            try {
                // Try to load BPT files to get process list
                const response = await fetch(`../data/bpt/${areaFolder}/`);
                const text = await response.text();
                
                // Parse directory listing (works with Python http.server)
                const matches = text.matchAll(/href="([^"]+_BPT_v3\.0\.json)"/g);
                const files = [...matches].map(m => m[1]);
                
                files.sort();
                
                for (const file of files) {
                    // Extract process name from filename
                    const processName = file
                        .replace(/_BPT_v3\.0\.json$/, '')
                        .replace(/^[A-Z]{2}_/, '')
                        .replace(/_/g, ' ');
                    
                    const opt = document.createElement('option');
                    opt.value = file.replace('_BPT_v3.0.json', '');
                    opt.textContent = processName;
                    processSelect.appendChild(opt);
                }
                
                if (files.length > 0) {
                    loadProcess();
                }
            } catch (e) {
                console.error('Error loading process list:', e);
                processSelect.innerHTML = '<option>Error loading processes</option>';
            }
        }

        // Load selected process (both BPT and BCM)
        async function loadProcess() {
            const areaFolder = document.getElementById('areaSelect').value;
            const processBase = document.getElementById('processSelect').value;
            
            if (!processBase) return;
            
            const bptFile = `../data/bpt/${areaFolder}/${processBase}_BPT_v3.0.json`;
            const bcmFile = `../data/bcm/${areaFolder}/${processBase}_BCM_v3.0.json`;
            
            // Load BPT
            document.getElementById('bptContent').innerHTML = '<span class="loading">Loading BPT...</span>';
            try {
                const response = await fetch(bptFile);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                currentBPT = await response.json();
                renderBPT();
            } catch (e) {
                currentBPT = null;
                document.getElementById('bptContent').innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
            
            // Load BCM
            document.getElementById('bcmContent').innerHTML = '<span class="loading">Loading BCM...</span>';
            try {
                const response = await fetch(bcmFile);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                currentBCM = await response.json();
                renderBCM();
            } catch (e) {
                currentBCM = null;
                document.getElementById('bcmContent').innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
        }

        // Render any value (recursive)
        function renderValue(value, depth = 0) {
            if (value === null || value === undefined) {
                return '<span class="empty">[null]</span>';
            }
            if (value === '') {
                return '<span class="empty">[empty string]</span>';
            }
            if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '<span class="empty">[empty array]</span>';
                }
                let html = '';
                value.forEach((item, i) => {
                    html += `<div class="array-item"><span class="array-index">[${i}]</span> ${renderValue(item, depth + 1)}</div>`;
                });
                return html;
            }
            if (typeof value === 'object') {
                let html = '<div class="nested">';
                for (const [k, v] of Object.entries(value)) {
                    html += `<div class="field"><div class="field-name">${escapeHtml(k)}:</div><div class="field-value">${renderValue(v, depth + 1)}</div></div>`;
                }
                html += '</div>';
                return html;
            }
            // String or primitive - preserve whitespace
            return escapeHtml(String(value));
        }

        // Render a field
        function renderField(name, value, cssClass = '') {
            const isEmpty = value === null || value === undefined || value === '' || 
                           (Array.isArray(value) && value.length === 0);
            return `
                <div class="field ${cssClass}">
                    <div class="field-name">${escapeHtml(name)}:</div>
                    <div class="field-value ${isEmpty ? 'empty' : ''}">${renderValue(value)}</div>
                </div>
            `;
        }

        // Render BPT
        function renderBPT() {
            if (!currentBPT) return;
            
            const showMeta = document.getElementById('showMetadata').checked;
            const showRaw = document.getElementById('showRawJson').checked;
            
            let html = '';
            
            // Raw JSON option
            if (showRaw) {
                html += `<div class="raw-json">${escapeHtml(JSON.stringify(currentBPT, null, 2))}</div>`;
            }
            
            // Top-level fields
            html += renderField('document_type', currentBPT.document_type);
            html += renderField('version', currentBPT.version);
            html += renderField('version_date', currentBPT.version_date);
            html += renderField('business_area', currentBPT.business_area);
            html += renderField('sub_category', currentBPT.sub_category);
            html += renderField('process_name', currentBPT.process_name);
            html += renderField('process_code', currentBPT.process_code);
            
            // Process details
            if (currentBPT.process_details) {
                const pd = currentBPT.process_details;
                html += '<div class="field"><div class="field-name">process_details:</div><div class="nested">';
                html += renderField('description', pd.description);
                html += renderField('trigger_events', pd.trigger_events);
                html += renderField('results', pd.results);
                html += renderField('process_steps', pd.process_steps);
                html += renderField('diagrams', pd.diagrams);
                html += renderField('shared_data', pd.shared_data);
                html += renderField('predecessor_processes', pd.predecessor_processes);
                html += renderField('successor_processes', pd.successor_processes);
                html += renderField('constraints', pd.constraints);
                html += renderField('failures', pd.failures);
                html += renderField('performance_measures', pd.performance_measures);
                html += '</div></div>';
            }
            
            // Metadata
            if (showMeta && currentBPT.metadata) {
                html += renderField('metadata', currentBPT.metadata, 'metadata');
            }
            
            document.getElementById('bptContent').innerHTML = html;
        }

        // Render BCM
        function renderBCM() {
            if (!currentBCM) return;
            
            const showMeta = document.getElementById('showMetadata').checked;
            const showRaw = document.getElementById('showRawJson').checked;
            
            let html = '';
            
            // Raw JSON option
            if (showRaw) {
                html += `<div class="raw-json">${escapeHtml(JSON.stringify(currentBCM, null, 2))}</div>`;
            }
            
            // Top-level fields
            html += renderField('document_type', currentBCM.document_type);
            html += renderField('version', currentBCM.version);
            html += renderField('version_date', currentBCM.version_date);
            html += renderField('business_area', currentBCM.business_area);
            html += renderField('sub_category', currentBCM.sub_category);
            html += renderField('process_name', currentBCM.process_name);
            html += renderField('process_code', currentBCM.process_code);
            
            // Maturity model with capability questions - TABLE FORMAT
            if (currentBCM.maturity_model && currentBCM.maturity_model.capability_questions) {
                html += '<div class="field"><div class="field-name">maturity_model.capability_questions:</div></div>';
                
                currentBCM.maturity_model.capability_questions.forEach((q, i) => {
                    html += `<div class="question-block">`;
                    html += `<div class="question-header">[${i}] Category: ${escapeHtml(q.category || '')}</div>`;
                    html += `<div class="question-text">Question: ${escapeHtml(q.question || '')}</div>`;
                    
                    if (q.note) {
                        html += `<div class="question-note">NOTE: ${escapeHtml(q.note)}</div>`;
                    }
                    
                    // Levels as table
                    if (q.levels) {
                        html += `<table class="levels-table">`;
                        html += `<tr><th>Level 1</th><th>Level 2</th><th>Level 3</th><th>Level 4</th><th>Level 5</th></tr>`;
                        html += `<tr>`;
                        html += `<td class="${q.levels.level_1 ? '' : 'empty'}">${escapeHtml(q.levels.level_1 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_2 ? '' : 'empty'}">${escapeHtml(q.levels.level_2 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_3 ? '' : 'empty'}">${escapeHtml(q.levels.level_3 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_4 ? '' : 'empty'}">${escapeHtml(q.levels.level_4 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_5 ? '' : 'empty'}">${escapeHtml(q.levels.level_5 || '[empty]')}</td>`;
                        html += `</tr></table>`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            // Legacy: capability_questions at top level (in case some files have this)
            if (currentBCM.capability_questions) {
                html += '<div class="field"><div class="field-name">capability_questions (legacy):</div></div>';
                currentBCM.capability_questions.forEach((q, i) => {
                    html += `<div class="question-block">`;
                    html += `<div class="question-header">[${i}] Category: ${escapeHtml(q.category || '')}</div>`;
                    html += `<div class="question-text">Question: ${escapeHtml(q.question || '')}</div>`;
                    if (q.note) {
                        html += `<div class="question-note">NOTE: ${escapeHtml(q.note)}</div>`;
                    }
                    if (q.levels) {
                        html += `<table class="levels-table">`;
                        html += `<tr><th>Level 1</th><th>Level 2</th><th>Level 3</th><th>Level 4</th><th>Level 5</th></tr>`;
                        html += `<tr>`;
                        html += `<td class="${q.levels.level_1 ? '' : 'empty'}">${escapeHtml(q.levels.level_1 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_2 ? '' : 'empty'}">${escapeHtml(q.levels.level_2 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_3 ? '' : 'empty'}">${escapeHtml(q.levels.level_3 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_4 ? '' : 'empty'}">${escapeHtml(q.levels.level_4 || '[empty]')}</td>`;
                        html += `<td class="${q.levels.level_5 ? '' : 'empty'}">${escapeHtml(q.levels.level_5 || '[empty]')}</td>`;
                        html += `</tr></table>`;
                    }
                    html += `</div>`;
                });
            }
            
            // Metadata
            if (showMeta && currentBCM.metadata) {
                html += renderField('metadata', currentBCM.metadata, 'metadata');
            }
            
            document.getElementById('bcmContent').innerHTML = html;
        }

        // Toggle raw JSON display
        function toggleRawJson() {
            rerender();
        }

        // Re-render both panels
        function rerender() {
            if (currentBPT) renderBPT();
            if (currentBCM) renderBCM();
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start
        init();
    </script>
</body>
</html>
